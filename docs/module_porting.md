# Инструкция по переносу функционала Monotrix в другой бот

Этот документ описывает внутреннюю работу игрового модуля Monotrix и
рассказывает, как перенести его в другой Telegram‑бот. Ниже собраны
принципы устройства системы, устройство базы данных, жизненный цикл
игры, а также полный перечень доступных команд.

## 1. Общие принципы работы

- Игра проходит в групповом чате. Пользователи присоединяются командой
  `/join` и заносятся в очередь ходов.
- Бот хранит состояние текущей партии в базе данных и восстанавливает его
  при перезапуске.
- Каждый ход выбирается случайный фантом из таблицы `Fant`, после чего
  игрок подтверждает его выполнением или использует `/skip`/`/pass`.
- Для контроля очереди используется поле `order` в модели
  `SessionPlayer`; после хода игрок перемещается в конец списка.
- Напоминания о необходимости сделать ход отправляются через задачу
  `ping_current_player`, запущенную с помощью `asyncio.create_task`.

### 1.1 Структура данных

`database.py` содержит модели SQLAlchemy:

- **Fant** – текст задания и автор.
- **SessionPlayer** – участник игры, его порядок хода и счётчик
  пропусков.
- **SessionState** – текущий ход, очередь и выбранный фантом.
- **Settings** – параметры игры (минимальное число игроков, задержка
  напоминаний, режим добавления фантов).

### 1.2 FSM добавления фантов

Файл `fsm.py` определяет состояния, используемые при вводе новых фантов.
Игрок отправляет `/add_fant`, после чего бот принимает текст заданий до
команды `/stop`. Состояния регистрируются в `Dispatcher`, что позволяет
отменять ввод и отслеживать контекст пользователя.

## 2. Структура модуля

Разделите код на пакет, который будет подключаться к основному боту.
Основные файлы:

- `database.py` – модели и функция `create_engine` для подключения к
  SQLite.
- `handlers/` – обработчики команд. Файлы разбиты по областям: управление
  игрой, очередь игроков, работа с фантами, настройки.
- `fsm.py` – описание состояний конечного автомата.
- `utils.py` – функции доступа к базе данных и проверки прав
  пользователей.

## 3. Зависимости и инфраструктура

- [Aiogram 3](https://docs.aiogram.dev) – основной фреймворк.
- SQLite + SQLAlchemy – хранение данных.
- При использовании других библиотек проверьте совместимость версий и
  отсутствие конфликтов зависимостей.

## 4. База данных

- Скопируйте модели из `database.py` или импортируйте модуль напрямую.
- Путь к базе данных можно переопределять через переменные окружения или
  параметры конфигурации.
- Первичная инициализация выполняется запуском `python database.py` или
  собственным скриптом миграций.

## 5. Жизненный цикл игры

1. Игроки подключаются `/join` и формируют очередь.
2. Администратор запускает игру командой `/start_game`.
3. Функция `start_turn` выбирает следующего игрока и фантом.
4. Игрок выполняет фантом (`/fant`) или пропускает ход (`/skip`,
   `/pass`).
5. После подтверждения хода очередь сдвигается, и начинается следующий
   раунд.

## 6. Полный список команд

### Общие

- `/start` – приветственное сообщение и создание базы данных при первом
  запуске.
- `/help` – краткая справка по возможностям бота.

### Управление игроками

- `/join` – вступление в игру.
- `/leave` – выход из игры.
- `/rename <ник>` – смена отображаемого имени игрока.

### Управление игрой

- `/start_game` – начало новой партии; доступно администратору.
- `/end_game` – завершение текущей игры с очисткой состояния.
- `/status` – просмотр текущей очереди и выбранного фантома.
- `/reset` – принудительная перезапуск игры без удаления игроков.
- `/kick <id>` – удалить игрока из текущей партии.

### Игровой процесс

- `/fant` – отправить текущему игроку его задание.
- `/skip` – пропустить ход, увеличив счётчик пропусков.
- `/pass` – передать фантом другому игроку без увеличения счётчика.
- `/punish` – выдать дополнительное задание нарушителю.
- `/reset_queue` – сбросить порядок очереди на начальное значение.

### Работа с фантами

- `/add_fant` – перейти в режим добавления новых заданий.
- `/stop` – выйти из режима добавления.
- `/clear_fants` – очистить все фанты из базы.
- `/reset_fants` – загрузить набор фантов по умолчанию.
- `/list_fants` – показать все текущие задания.
- `/delete_fant <id>` – удалить фантом по идентификатору.

### Настройки

- `/show_settings` – вывести текущие параметры игры.
- `/set_min_players <n>` – минимальное число участников для старта.
- `/set_reminder_delay <сек>` – задержка между напоминаниями.
- `/set_add_mode <mode>` – режим добавления фантов (`all` или `admins`).

Каждую команду при необходимости можно переименовать, но рекомендуется
сохранять исходную логику и параметры.

## 7. Подключение модуля

1. Создайте пакет `monotrix_module` и перенесите в него файлы.
2. В основном боте инициализируйте `Bot` и `Dispatcher`.
3. Подключите роутеры:

   ```python
   from monotrix_module.handlers import router as monotrix_router

   dp.include_router(monotrix_router)
   ```

4. Убедитесь, что токены и настройки находятся в конфигурации проекта.
5. При необходимости настройте префиксы команд или фильтры чатов.

## 8. Подводные камни и рекомендации

- Очищайте таблицы `SessionPlayer` и `SessionState` при завершении игры,
  чтобы не смешивать партии.
- Административные команды следует ограничивать по списку `ADMIN_IDS`.
- Обрабатывайте исключения при отправке сообщений: пользователь мог
  заблокировать бота.
- При большом количестве задач следите за корректным завершением
  фоновых `asyncio`‑tasks.

Следуя этим шагам и рекомендациям, вы сможете внедрить игровой модуль
Monotrix в любой Telegram‑бот, полностью сохранив принципы его работы и
поведение команд.

