# Monotrix: обзор и принцип работы

Monotrix — Telegram-бот, который проводит игру с фантом ("фантами"). Игроки подключаются к группе, получают задания и выполняют их по очереди. Проект построен на [Aiogram 3](https://docs.aiogram.dev) и использует SQLite через SQLAlchemy.

## Структура проекта

| Файл | Назначение |
|------|------------|
| `bot.py` | Точка входа. Создаёт `Bot` и `Dispatcher`, подключает роутеры и запускает polling. |
| `config.py` | Конфигурация: токен бота, адрес БД и список администраторов. |
| `database.py` | Описание таблиц `Fant`, `SessionPlayer`, `SessionState`, `Settings` и создание движка базы. |
| `fsm.py` | FSM-состояние для добавления новых фантов. |
| `handlers/` | Набор модулей с обработчиками команд. |
| `keyboards.py` | Инлайн-клавиатуры. Сейчас используется одна кнопка для завершения добавления фантов. |
| `utils.py` | Вспомогательные функции: работа с БД, проверки прав, безопасная отправка сообщений. |

## Принцип работы

1. **Подготовка игры.** Администраторы запускают бота и наполняют базу фантами с помощью команды `/add_fant`.
2. **Подключение игроков.** Участники присоединяются к игре командой `/join <имя>` и могут покинуть её через `/leave` или изменить имя `/rename`.
3. **Старт игры.** Команда `/start_game` проверяет минимальное число игроков, перемешивает очередь и сохраняет её в таблице `SessionState`. Далее вызывается `start_turn`, который показывает порядок хода.
4. **Получение фанта.** Игрок по очереди вызывает `/fant`. Из таблицы `Fant` выбирается случайный неиспользованный фант, помечается как использованный и отправляется игроку. После этого ход переходит к следующему участнику.
5. **Переход хода и напоминания.** Функция `start_turn` продвигает индекс очереди, а `ping_current_player` по истечении `reminder_delay` напоминает игроку выполнить команду `/fant`.
6. **Управление игрой.** Модуль `game_control` содержит команды для сброса игры (`/reset`), просмотра статуса (`/status`), досрочного завершения (`/end_game`) и исключения игрока (`/kick`).
7. **Настройки.** Команды из модуля `settings` позволяют админам задать минимум игроков, задержку напоминаний и режим добавления фантов.

## База данных

- **Fant** — тексты фантов и информация об авторе.
- **SessionPlayer** — игроки, участвующие в текущей сессии.
- **SessionState** — состояние игры: порядок хода, индекс текущего игрока и номер раунда.
- **Settings** — глобальные настройки игры.

## Основные команды

- `/start` и `/help` — приветствие и список команд.
- `/join <имя>` и `/leave` — управление участием в игре.
- `/start_game`, `/reset`, `/status`, `/end_game` — администрирование.
- `/fant`, `/punish`, `/skip`, `/pass` — игровой процесс.
- `/add_fant`, `/list_fants`, `/delete_fant`, `/reset_queue` — работа с фантоми и очередью.
- `/show_settings`, `/set_min_players`, `/set_reminder_delay`, `/set_add_mode` — настройки бота.

## Запуск

1. Установите зависимости: `pip install -r requirements.txt`.
2. Заполните `TOKEN` и при необходимости `ADMIN_IDS` в `config.py`.
3. Создайте базу данных: `python database.py` (при первом запуске).
4. Запустите бота: `python bot.py`.

Документация предназначена для быстрого понимания структуры и логики проекта. Используйте её как отправную точку для дальнейших доработок.

